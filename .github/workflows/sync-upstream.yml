name: Sync Upstream Repository

# Workflow to automatically sync fork with upstream repository
# Fetches changes from upstream and merges them into the fork
# Pushing changes triggers Vercel deployment automatically

on:
  # Run every hour to check for upstream updates
  schedule:
    - cron: '0 * * * *'
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        env:
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          # Construct URL with token for authentication if PAT is provided
          if [ -n "$UPSTREAM_TOKEN" ]; then
            UPSTREAM_URL="https://$UPSTREAM_TOKEN@github.com/tayawaaean/solar-x.git"
            echo "Using Personal Access Token for upstream access"
          else
            UPSTREAM_URL="https://github.com/tayawaaean/solar-x.git"
            echo "Using public access (no token)"
          fi
          git remote add upstream $UPSTREAM_URL || git remote set-url upstream $UPSTREAM_URL
          git remote -v
      
      - name: Fetch upstream changes
        env:
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          # Configure credential helper if PAT is available
          if [ -n "$UPSTREAM_TOKEN" ]; then
            git config credential.helper store
            echo "https://$UPSTREAM_TOKEN@github.com" > ~/.git-credentials
          fi
          git fetch upstream || {
            echo "::error::Failed to fetch from upstream repository"
            echo "This could mean:"
            echo "1. The repository is private and requires a Personal Access Token"
            echo "2. The repository URL is incorrect"
            echo "3. The token doesn't have access to the upstream repository"
            echo ""
            echo "Please add a Personal Access Token with 'repo' scope as UPSTREAM_SYNC_TOKEN secret"
            echo "See .github/workflows/README.md for detailed instructions"
            exit 1
          }
          git fetch origin
      
      - name: Check for upstream changes
        id: check-changes
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/$CURRENT_BRANCH --count || echo "0")
          echo "Upstream commits ahead: $UPSTREAM_COMMITS"
          echo "has_changes=$([ "$UPSTREAM_COMMITS" -gt 0 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "commit_count=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
      
      - name: Merge upstream changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Merging upstream/$CURRENT_BRANCH into $CURRENT_BRANCH"
          git merge upstream/$CURRENT_BRANCH --no-edit --no-ff || exit 1
      
      - name: Push changes to fork
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Pushing merged changes to origin/$CURRENT_BRANCH"
          git push origin $CURRENT_BRANCH
      
      - name: Report status
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "Successfully synced ${{ steps.check-changes.outputs.commit_count }} commit(s) from upstream"
            echo "Vercel deployment should be triggered automatically"
          else
            echo "No new changes from upstream. Fork is up to date."
          fi
