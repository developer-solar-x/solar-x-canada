name: Sync Upstream Repository

# Workflow to automatically sync fork with upstream repository
# Fetches changes from upstream and merges them into the fork
# Pushing changes triggers Vercel deployment automatically

on:
  # Run every hour to check for upstream updates
  schedule:
    - cron: '0 * * * *'
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        env:
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          # Check if token is available
          if [ -z "$UPSTREAM_TOKEN" ]; then
            echo "::warning::UPSTREAM_SYNC_TOKEN secret is not set"
            echo "The upstream repository appears to be private. Please add a Personal Access Token."
            echo "See .github/workflows/README.md for instructions"
          fi
          
          # Add upstream remote (we'll configure auth in the next step)
          git remote add upstream https://github.com/tayawaaean/solar-x.git 2>/dev/null || git remote set-url upstream https://github.com/tayawaaean/solar-x.git
          git remote -v
      
      - name: Fetch upstream changes
        env:
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          # Configure authentication for private upstream repository
          if [ -n "$UPSTREAM_TOKEN" ]; then
            echo "Configuring authentication with Personal Access Token"
            # Update remote URL to include token
            git remote set-url upstream https://$UPSTREAM_TOKEN@github.com/tayawaaean/solar-x.git
            # Also configure credential helper as backup
            git config credential.helper store
            echo "https://$UPSTREAM_TOKEN@github.com" > ~/.git-credentials
            chmod 600 ~/.git-credentials
            echo "Authentication configured"
          else
            echo "::error::UPSTREAM_SYNC_TOKEN secret is not set"
            echo "The upstream repository is private and requires authentication."
            echo ""
            echo "To fix this:"
            echo "1. Create a Personal Access Token with 'repo' scope"
            echo "2. Add it as a secret named 'UPSTREAM_SYNC_TOKEN' in your repository"
            echo "3. See .github/workflows/README.md for detailed instructions"
            exit 1
          fi
          
          # Fetch from upstream
          echo "Fetching from upstream repository..."
          git fetch upstream || {
            echo "::error::Failed to fetch from upstream repository"
            echo ""
            echo "Possible causes:"
            echo "1. The UPSTREAM_SYNC_TOKEN secret is not set or is invalid"
            echo "2. The token doesn't have 'repo' scope"
            echo "3. The token doesn't have access to the upstream repository"
            echo "4. The repository URL is incorrect: https://github.com/tayawaaean/solar-x.git"
            echo ""
            echo "To verify:"
            echo "- Check that the secret 'UPSTREAM_SYNC_TOKEN' exists in Settings > Secrets and variables > Actions"
            echo "- Ensure the token has 'repo' scope and access to the upstream repository"
            exit 1
          }
          
          echo "Successfully fetched from upstream"
          git fetch origin
      
      - name: Check for upstream changes
        id: check-changes
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/$CURRENT_BRANCH --count || echo "0")
          echo "Upstream commits ahead: $UPSTREAM_COMMITS"
          echo "has_changes=$([ "$UPSTREAM_COMMITS" -gt 0 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "commit_count=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
      
      - name: Merge upstream changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Merging upstream/$CURRENT_BRANCH into $CURRENT_BRANCH"
          git merge upstream/$CURRENT_BRANCH --no-edit --no-ff || exit 1
      
      - name: Push changes to fork
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Pushing merged changes to origin/$CURRENT_BRANCH"
          git push origin $CURRENT_BRANCH
      
      - name: Report status
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "Successfully synced ${{ steps.check-changes.outputs.commit_count }} commit(s) from upstream"
            echo "Vercel deployment should be triggered automatically"
          else
            echo "No new changes from upstream. Fork is up to date."
          fi
