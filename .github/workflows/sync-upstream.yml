name: Sync Upstream Repository

# Workflow to automatically sync fork with upstream repository
# Fetches changes from upstream and merges them into the fork
# Pushing changes triggers Vercel deployment automatically

on:
  # Run every 5 minutes to check for upstream updates
  schedule:
    - cron: '*/5 * * * *'
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Setup SSH for upstream
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
        run: |
          # Check if SSH key is available, otherwise fall back to HTTPS token
          if [ -n "$UPSTREAM_SSH_KEY" ]; then
            echo "SSH key detected, configuring SSH authentication for upstream repository"
            mkdir -p ~/.ssh
            echo "$UPSTREAM_SSH_KEY" > ~/.ssh/upstream_key
            chmod 600 ~/.ssh/upstream_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            # Verify the key format
            if grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/upstream_key; then
              echo "SSH private key format verified"
            else
              echo "::warning::SSH key may be incorrectly formatted"
            fi
            echo "SSH configured successfully"
          else
            echo "SSH key not found (UPSTREAM_SSH_KEY secret is not set), will use HTTPS with token"
          fi
      
      - name: Check authentication secrets
        id: check-auth
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          echo "=== Checking authentication secrets ==="
          if [ -n "$UPSTREAM_SSH_KEY" ]; then
            echo "AUTH_METHOD=ssh" >> $GITHUB_OUTPUT
            echo "✓ UPSTREAM_SSH_KEY secret is set (length: ${#UPSTREAM_SSH_KEY})"
          elif [ -n "$UPSTREAM_TOKEN" ]; then
            echo "AUTH_METHOD=token" >> $GITHUB_OUTPUT
            echo "✓ UPSTREAM_SYNC_TOKEN secret is set (length: ${#UPSTREAM_TOKEN})"
            echo "Token preview: ${UPSTREAM_TOKEN:0:7}..."
          else
            echo "AUTH_METHOD=none" >> $GITHUB_OUTPUT
            echo "✗ No authentication secrets found!"
            echo "::error::Neither UPSTREAM_SSH_KEY nor UPSTREAM_SYNC_TOKEN secrets are set"
            exit 1
          fi
          echo "========================================"
      
      - name: Add upstream remote
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
          AUTH_METHOD: ${{ steps.check-auth.outputs.AUTH_METHOD }}
        run: |
          echo "Adding upstream remote using method: $AUTH_METHOD"
          if [ "$AUTH_METHOD" = "ssh" ]; then
            UPSTREAM_URL="git@github.com:tayawaaean/solar-x.git"
            echo "Using SSH: $UPSTREAM_URL"
          elif [ "$AUTH_METHOD" = "token" ]; then
            UPSTREAM_URL="https://$UPSTREAM_TOKEN@github.com/tayawaaean/solar-x.git"
            echo "Using HTTPS with token (token hidden)"
          else
            echo "::error::No authentication method available"
            exit 1
          fi
          
          git remote add upstream $UPSTREAM_URL 2>/dev/null || git remote set-url upstream $UPSTREAM_URL
          echo "Remote configured. Current remotes:"
          git remote -v
      
      - name: Fetch upstream changes
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
          AUTH_METHOD: ${{ steps.check-auth.outputs.AUTH_METHOD }}
        run: |
          echo "Fetching from upstream using method: $AUTH_METHOD"
          
          if [ "$AUTH_METHOD" = "ssh" ]; then
            echo "Fetching using SSH..."
            GIT_SSH_COMMAND="ssh -i ~/.ssh/upstream_key -o IdentitiesOnly=yes" git fetch upstream || {
              echo "::error::Failed to fetch from upstream repository using SSH"
              exit 1
            }
          elif [ "$AUTH_METHOD" = "token" ]; then
            echo "Fetching using HTTPS with token..."
            # Ensure remote URL has token embedded
            git remote set-url upstream https://$UPSTREAM_TOKEN@github.com/tayawaaean/solar-x.git
            # Configure credential helper as backup
            git config credential.helper store
            echo "https://$UPSTREAM_TOKEN@github.com" > ~/.git-credentials
            chmod 600 ~/.git-credentials
            # Verify remote URL (mask token)
            echo "Remote URL configured:"
            git remote get-url upstream | sed 's/ghp_[^@]*/ghp_***HIDDEN***/g'
            # Fetch from upstream
            echo "Executing: git fetch upstream"
            git fetch upstream || {
              echo "::error::Failed to fetch from upstream repository"
              echo "Token length: ${#UPSTREAM_TOKEN}"
              echo "Verify the UPSTREAM_SYNC_TOKEN secret is set correctly"
              exit 1
            }
          else
            echo "::error::No authentication method available"
            exit 1
          fi
          
          echo "✓ Successfully fetched from upstream"
          git fetch origin
      
      - name: Check for upstream changes
        id: check-changes
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/$CURRENT_BRANCH --count || echo "0")
          echo "Upstream commits ahead: $UPSTREAM_COMMITS"
          echo "has_changes=$([ "$UPSTREAM_COMMITS" -gt 0 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "commit_count=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
      
      - name: Merge upstream changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Merging upstream/$CURRENT_BRANCH into $CURRENT_BRANCH"
          git merge upstream/$CURRENT_BRANCH --no-edit --no-ff || exit 1
      
      - name: Push changes to fork
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Pushing merged changes to origin/$CURRENT_BRANCH"
          git push origin $CURRENT_BRANCH
      
      - name: Report status
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "Successfully synced ${{ steps.check-changes.outputs.commit_count }} commit(s) from upstream"
            echo "Vercel deployment should be triggered automatically"
          else
            echo "No new changes from upstream. Fork is up to date."
          fi
