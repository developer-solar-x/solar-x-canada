name: Sync Upstream Repository

# Workflow to automatically sync fork with upstream repository
# Fetches changes from upstream and merges them into the fork
# Pushing changes triggers Vercel deployment automatically

on:
  # Run every hour to check for upstream updates
  schedule:
    - cron: '0 * * * *'
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Setup SSH for upstream
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
        run: |
          # Check if SSH key is available, otherwise fall back to HTTPS token
          if [ -n "$UPSTREAM_SSH_KEY" ]; then
            echo "Configuring SSH authentication for upstream repository"
            mkdir -p ~/.ssh
            echo "$UPSTREAM_SSH_KEY" > ~/.ssh/upstream_key
            chmod 600 ~/.ssh/upstream_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            echo "SSH configured"
          else
            echo "SSH key not found, will use HTTPS with token"
          fi
      
      - name: Add upstream remote
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          # Use SSH if key is available, otherwise use HTTPS with token
          if [ -n "$UPSTREAM_SSH_KEY" ]; then
            UPSTREAM_URL="git@github.com:tayawaaean/solar-x.git"
            echo "Using SSH for upstream repository"
          elif [ -n "$UPSTREAM_TOKEN" ]; then
            UPSTREAM_URL="https://$UPSTREAM_TOKEN@github.com/tayawaaean/solar-x.git"
            echo "Using HTTPS with Personal Access Token for upstream repository"
          else
            UPSTREAM_URL="https://github.com/tayawaaean/solar-x.git"
            echo "::warning::No authentication method configured. This may fail for private repositories."
          fi
          
          git remote add upstream $UPSTREAM_URL 2>/dev/null || git remote set-url upstream $UPSTREAM_URL
          git remote -v
      
      - name: Fetch upstream changes
        env:
          UPSTREAM_SSH_KEY: ${{ secrets.UPSTREAM_SSH_KEY }}
          UPSTREAM_TOKEN: ${{ secrets.UPSTREAM_SYNC_TOKEN }}
        run: |
          # Configure authentication based on available method
          if [ -n "$UPSTREAM_SSH_KEY" ]; then
            echo "Fetching from upstream using SSH..."
            GIT_SSH_COMMAND="ssh -i ~/.ssh/upstream_key -o IdentitiesOnly=yes" git fetch upstream || {
              echo "::error::Failed to fetch from upstream repository using SSH"
              echo ""
              echo "Possible causes:"
              echo "1. The UPSTREAM_SSH_KEY secret is invalid or incorrectly formatted"
              echo "2. The SSH key is not added as a deploy key to tayawaaean/solar-x"
              echo "3. The deploy key doesn't have read access"
              echo ""
              echo "See .github/workflows/README.md for SSH key setup instructions"
              exit 1
            }
          elif [ -n "$UPSTREAM_TOKEN" ]; then
            echo "Fetching from upstream using HTTPS with token..."
            # Configure credential helper for HTTPS
            git config credential.helper store
            echo "https://$UPSTREAM_TOKEN@github.com" > ~/.git-credentials
            chmod 600 ~/.git-credentials
            git fetch upstream || {
              echo "::error::Failed to fetch from upstream repository using HTTPS"
              echo ""
              echo "Possible causes:"
              echo "1. The UPSTREAM_SYNC_TOKEN secret is not set or is invalid"
              echo "2. The token doesn't have 'repo' scope"
              echo "3. The token doesn't have access to the upstream repository"
              echo "4. The repository URL is incorrect"
              echo ""
              echo "See .github/workflows/README.md for token setup instructions"
              exit 1
            }
          else
            echo "::error::No authentication method configured"
            echo "The upstream repository is private and requires authentication."
            echo ""
            echo "Please configure either:"
            echo "1. UPSTREAM_SSH_KEY secret (recommended for private repos)"
            echo "2. UPSTREAM_SYNC_TOKEN secret (Personal Access Token)"
            echo ""
            echo "See .github/workflows/README.md for detailed instructions"
            exit 1
          fi
          
          echo "Successfully fetched from upstream"
          git fetch origin
      
      - name: Check for upstream changes
        id: check-changes
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/$CURRENT_BRANCH --count || echo "0")
          echo "Upstream commits ahead: $UPSTREAM_COMMITS"
          echo "has_changes=$([ "$UPSTREAM_COMMITS" -gt 0 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "commit_count=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
      
      - name: Merge upstream changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Merging upstream/$CURRENT_BRANCH into $CURRENT_BRANCH"
          git merge upstream/$CURRENT_BRANCH --no-edit --no-ff || exit 1
      
      - name: Push changes to fork
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Pushing merged changes to origin/$CURRENT_BRANCH"
          git push origin $CURRENT_BRANCH
      
      - name: Report status
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "Successfully synced ${{ steps.check-changes.outputs.commit_count }} commit(s) from upstream"
            echo "Vercel deployment should be triggered automatically"
          else
            echo "No new changes from upstream. Fork is up to date."
          fi
